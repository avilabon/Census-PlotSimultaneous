<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MVP Cens d'ocells per parcel·les</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #app { display: grid; grid-template-columns: 1fr 380px; grid-template-rows: auto 1fr auto; height: 100%; }
    header { grid-column: 1 / -1; padding: 10px 14px; border-bottom: 1px solid #e5e7eb; display: flex; gap: 12px; align-items: center; }
    #map { height: 100%; }
    aside { border-left: 1px solid #e5e7eb; padding: 10px; overflow: auto; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn { padding: 8px 10px; border: 1px solid #e5e7eb; border-radius: 10px; background: #fff; cursor: pointer; }
    .btn.primary { background: #111827; color: #fff; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    label { display:block; font-size: 12px; color:#374151; margin-top: 8px; }
    input, select, textarea { width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 8px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border-bottom: 1px solid #eee; text-align: left; padding: 6px 4px; font-size: 12px; }
    .pill { display:inline-block; padding:2px 6px; border-radius:999px; background:#f3f4f6; font-size:12px; }
    footer { grid-column: 1 / -1; border-top: 1px solid #e5e7eb; padding: 8px 14px; font-size: 12px; color:#6b7280; }
    details { margin-top: 8px; }
    .test-pass { color: #065f46; }
    .test-fail { color: #991b1b; }
  </style>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#111827" />
</head>
<body>
<div id="app">
  <header>
    <strong>MVP Cens d'ocells</strong>
    <div class="controls">
      <button class="btn" id="btnLoadParcel">Carrega parcel·la</button>
      <button class="btn" id="btnClear">Neteja observacions</button>
      <button class="btn" id="btnExportCSV">Exporta CSV</button>
      <button class="btn" id="btnExportGeoJSON">Exporta GeoJSON</button>
      <button class="btn primary" id="btnSubmit">Envia al servidor</button>
    </div>
    <span style="margin-left:auto" class="pill" id="status">Offline (local)</span>
  </header>

  <div id="map"></div>

  <aside>
    <h3>Observacions</h3>
    <div id="obsCount">0 registres</div>
    <div style="max-height: 40vh; overflow:auto; border:1px solid #eee; border-radius:8px; padding:4px; margin-top:6px">
      <table id="obsTable">
        <thead>
          <tr>
            <th>Hora</th>
            <th>Espècie</th>
            <th>N</th>
            <th>Lat</th>
            <th>Lng</th>
            <th>Fiabilitat</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <details>
      <summary>Configuració</summary>
      <label>Identificador d'observador
        <input id="observerId" placeholder="Ex: OBS-012" />
      </label>
      <label>Identificador de parcel·la
        <input id="parcelId" placeholder="Ex: PARC-17A" />
      </label>
      <label>Endpoint d'enviament (POST JSON)
        <input id="endpoint" placeholder="https://exemple.org/api/upload" />
      </label>
      <label>Llista d'espècies (separades per comes)
        <textarea id="speciesList" rows="3" placeholder="Turdus merula, Parus major, ..."></textarea>
      </label>
    </details>

    <details>
      <summary>Carrega parcel·la (GeoJSON)</summary>
      <label>Enganxa GeoJSON (Polygon o MultiPolygon)
        <textarea id="geojsonInput" rows="6" placeholder='{"type":"Feature","properties":{},"geometry":{"type":"Polygon","coordinates":[[...] ]}}'></textarea>
      </label>
      <button class="btn" id="btnApplyGeoJSON">Dibuixa</button>
    </details>

    <details open>
      <summary>Tests</summary>
      <div id="testOutput" style="font-size:12px"></div>
    </details>
  </aside>

  <footer>
    Fes clic dins la parcel·la per afegir el punt on s'ha sentit/observat l'ocell. Les dades es guarden localment fins que les exportis o les enviïs.
  </footer>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
// --- Helpers de compatibilitat ---
function uid(){
  try {
    if (window.crypto && typeof window.crypto.randomUUID === 'function') {
      return window.crypto.randomUUID();
    }
  } catch(e) { /* entorns sense crypto */ }
  return (
    Date.now().toString(36) + '-' +
    Math.random().toString(36).slice(2, 10)
  );
}

function nullSafe(v){
  return (v === undefined || v === null) ? '' : v;
}

// --- Estat ---
const state = {
  parcel: null,
  parcelGeom: null,
  observations: (function(){
    try { return JSON.parse(localStorage.getItem('observations') || '[]'); }
    catch(e){ return []; }
  })()
};

const map = L.map('map');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
map.setView([41.387, 2.170], 12);

function fmtTime(ts){
  const d = new Date(ts);
  try { return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'}); }
  catch(e){ return d.toTimeString().slice(0,8); }
}

function refreshTable(){
  const tbody = document.querySelector('#obsTable tbody');
  tbody.innerHTML = '';
  for (var i=0; i<state.observations.length; i++){
    var o = state.observations[i];
    const tr = document.createElement('tr');
    tr.innerHTML = '<td>'+fmtTime(o.timestamp)+'</td>'+
                   '<td>'+ (o.species || '') +'</td>'+
                   '<td>'+ (o.count || '') +'</td>'+
                   '<td>'+ o.lat.toFixed(5) +'</td>'+
                   '<td>'+ o.lng.toFixed(5) +'</td>'+
                   '<td>'+ (o.confidence || '') +'</td>';
    tbody.appendChild(tr);
  }
  document.getElementById('obsCount').textContent = state.observations.length + ' registres';
  try { localStorage.setItem('observations', JSON.stringify(state.observations)); } catch(e){}
}

function insideParcel(latlng){
  if(!state.parcelGeom) return true;
  function pointInPoly(point, vs){
    const x = point[0], y = point[1];
    let inside = false;
    for (let i=0, j=vs.length-1; i<vs.length; j=i++){
      const xi = vs[i][0], yi = vs[i][1];
      const xj = vs[j][0], yj = vs[j][1];
      const intersect = ((yi>y)!==(yj>y)) && (x < (xj-xi)*(y-yi)/(yj-yi)+xi);
      if (intersect) inside = !inside;
    }
    return inside;
  }
  const g = state.parcelGeom;
  if(g.type === 'Polygon'){
    return pointInPoly([latlng.lng, latlng.lat], g.coordinates[0]);
  } else if(g.type === 'MultiPolygon'){
    for (var k=0; k<g.coordinates.length; k++){
      if (pointInPoly([latlng.lng, latlng.lat], g.coordinates[k][0])) return true;
    }
    return false;
  }
  return true;
}

function addObservation(latlng){
  const speciesOptions = (document.getElementById('speciesList').value||'').split(',').map(function(s){return s.trim();}).filter(function(x){return !!x;});
  const speciesSelect = speciesOptions.length ? '<label>Espècie<select id="fSpecies">'+ speciesOptions.map(function(s){return '<option>'+s+'</option>';}).join('') +'</select></label>' : '<label>Espècie<input id="fSpeciesInput" placeholder="Espècie" /></label>';

  const popup = L.popup({offset: [0,-10]})
    .setLatLng(latlng)
    .setContent(
      '<div style="min-width:240px">'+
        speciesSelect+
        '<label>N individus<input id="fCount" type="number" min="1" step="1" value="1"/></label>'+
        '<label>Distància estimada (m)<input id="fDistance" type="number" min="0" step="1"/></label>'+
        '<label>Rumb (° des del nord)<input id="fBearing" type="number" min="0" max="359" step="1"/></label>'+
        '<label>Fiabilitat<select id="fConfidence"><option>segur</option><option>probable</option><option>possible</option></select></label>'+
        '<label>Notes<textarea id="fNotes" rows="2"></textarea></label>'+
        '<div style="display:flex; gap:8px; margin-top:8px">'+
          '<button class="btn primary" id="fSave">Desa</button>'+
          '<button class="btn" id="fCancel">Cancel·la</button>'+
        '</div>'+
      '</div>'
    )
    .openOn(map);

  setTimeout(function(){
    document.getElementById('fCancel').onclick = function(){ map.closePopup(popup); };
    document.getElementById('fSave').onclick = function(){
      const observerId = document.getElementById('observerId').value||null;
      const parcelId = document.getElementById('parcelId').value||null;
      const species = speciesOptions.length ? document.getElementById('fSpecies').value : document.getElementById('fSpeciesInput').value;
      const o = {
        id: uid(),
        observerId: observerId,
        parcelId: parcelId,
        species: species || null,
        count: Number(document.getElementById('fCount').value)||null,
        distance_m: Number(document.getElementById('fDistance').value)||null,
        bearing_deg: Number(document.getElementById('fBearing').value)||null,
        confidence: document.getElementById('fConfidence').value||null,
        notes: document.getElementById('fNotes').value||null,
        lat: latlng.lat,
        lng: latlng.lng,
        timestamp: Date.now(),
        crs: 'EPSG:4326',
        device: navigator.userAgent
      };
      state.observations.push(o);
      L.circleMarker(latlng, {radius:6}).addTo(map).bindTooltip((o.species||'sp.') + ' (' + (o.count||1) + ')');
      refreshTable();
      map.closePopup(popup);
    };
  }, 0);
}

map.on('click', function(e){
  if(state.parcelGeom && !insideParcel(e.latlng)){
    alert("El punt ha d'estar dins de la parcel·la.");
    return;
  }
  addObservation(e.latlng);
});

// --- Parcel·la demo per defecte ---
const demoParcel = {
  "type":"Feature",
  "properties":{"name":"DEMO"},
  "geometry":{"type":"Polygon","coordinates":[[
    [2.1638,41.3894],[2.1695,41.3894],[2.1695,41.3862],[2.1638,41.3862],[2.1638,41.3894]
  ]]}
};

function drawParcel(feature){
  if(state.parcel){ map.removeLayer(state.parcel); }
  state.parcelGeom = feature.geometry;
  state.parcel = L.geoJSON(feature, {style:{color:'#2563eb', weight:2, fillOpacity:0.05}}).addTo(map);
  try { map.fitBounds(state.parcel.getBounds(), {padding:[20,20]}); } catch(e){ /* ignore */ }
}

drawParcel(demoParcel);

// --- Botons ---
document.getElementById('btnClear').onclick = function(){
  if(!confirm('Segur que vols esborrar totes les observacions locals?')) return;
  state.observations = [];
  refreshTable();
  location.reload();
};

function toCSV(rows){
  const header = Object.keys(rows[0]||{observerId:'',parcelId:'',species:'',count:'',distance_m:'',bearing_deg:'',confidence:'',notes:'',lat:'',lng:'',timestamp:'',crs:'',device:''});
  return [header.join(',')]
    .concat(rows.map(function(r){ return header.map(function(k){ return JSON.stringify(nullSafe(r[k])); }).join(','); }))
    .join('\n');
}

function download(filename, content, mime){
  try{
    const blob = new Blob([content], {type:mime||'application/octet-stream'});
    if (navigator.msSaveOrOpenBlob) {
      navigator.msSaveOrOpenBlob(blob, filename);
      return true;
    }
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.setAttribute('download', filename);
    document.body.appendChild(a);
    a.click();
    setTimeout(function(){
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 0);
    return true;
  } catch (err){
    try{
      const text = (typeof content === 'string') ? content : String(content);
      if (navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(function(){
          alert('No s\'ha pogut descarregar. Copiat al porta-retalls. Desa-ho com a '+filename);
        });
        return false;
      }
    } catch(_){}
    const win = window.open('', '_blank');
    if (win) {
      win.document.open();
      const escaped = String(content).replace(/[&<>]/g, function(s){ return {'&':'&amp;','<':'&lt;','>':'&gt;'}[s]; });
      win.document.write('<pre>'+escaped+'</pre>');
      win.document.close();
      alert('S\'ha obert en una pestanya nova. Desa-ho manualment com "'+filename+'".');
    } else {
      alert('No s\'ha pogut exportar. Comprova bloqueig de baixades o emergents.');
    }
    return false;
  }
}

document.getElementById('btnExportCSV').onclick = function(){
  if(state.observations.length===0) return alert('No hi ha dades.');
  download('cens_'+ new Date().toISOString().slice(0,10) + '.csv', toCSV(state.observations), 'text/csv');
};

document.getElementById('btnExportGeoJSON').onclick = function(){
  const fc = { type:'FeatureCollection', features: state.observations.map(function(o){return ({
    type:'Feature', properties:Object.assign({}, o), geometry:{ type:'Point', coordinates:[o.lng,o.lat] }
  });}) };
  download('cens_'+ new Date().toISOString().slice(0,10) + '.geojson', JSON.stringify(fc), 'application/geo+json');
};

document.getElementById('btnSubmit').onclick = function(){
  (async function(){
    const endpoint = (document.getElementById('endpoint').value||'').trim();
    if(!endpoint) { alert("Cal indicar un endpoint d'enviament."); return; }
    const payload = {
      meta: { schema: 'bird-census.v1', submitted_at: new Date().toISOString(), app: 'mvp-leaflet' },
      parcel: state.parcelGeom,
      observations: state.observations
    };
    try{
      document.getElementById('status').textContent = 'Enviant…';
      const res = await fetch(endpoint, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      if(!res.ok) throw new Error('Error '+res.status);
      document.getElementById('status').textContent = 'Dades enviades ✅';
    } catch(err){
      document.getElementById('status').textContent = "Error d'enviament";
      alert("No s'ha pogut enviar: "+ err.message);
    }
  })();
};

const applyGeo = function(){
  const txt = (document.getElementById('geojsonInput').value||'').trim();
  if(!txt) { alert('Enganxa el GeoJSON de la parcel·la.'); return; }
  let feat = null;
  try{
    const obj = JSON.parse(txt);
    feat = obj.type === 'Feature' ? obj : {type:'Feature', properties:{}, geometry: obj};
    if(!feat.geometry || (['Polygon','MultiPolygon'].indexOf(feat.geometry.type) === -1)) throw new Error('Ha de ser Polygon o MultiPolygon');
  }catch(e){
    alert('GeoJSON no vàlid: '+e.message); return;
  }
  drawParcel(feat);
};
document.getElementById('btnApplyGeoJSON').onclick = applyGeo;

document.getElementById('btnLoadParcel').onclick = function(){
  var sec = Array.prototype.find.call(document.querySelectorAll('details'), function(d){ return d.querySelector('#geojsonInput'); });
  if (sec) { sec.open = true; }
  document.getElementById('geojsonInput').focus();
};

refreshTable();

// --- TESTS senzills ---
(function runTests(){
  const out = document.getElementById('testOutput');
  function log(ok, msg){
    const el = document.createElement('div');
    el.className = ok ? 'test-pass' : 'test-fail';
    el.textContent = (ok ? '✓ ' : '✗ ') + msg;
    out.appendChild(el);
  }
  try{
    const a = uid(); const b = uid();
    log(a !== b && typeof a === 'string' && a.length > 5, 'uid() genera identificadors aparentment únics');
  } catch(e){ log(false, 'uid() ha fallat: '+e.message); }

  try{
    const csv = toCSV([{observerId:'OBS', parcelId:'PAR', species:'sp', count:1, distance_m:10, bearing_deg:90, confidence:'segur', notes:'-', lat:1.1, lng:2.2, timestamp:123, crs:'EPSG:4326', device:'test'}]);
    log(/observerId/.test(csv) && /"sp"/.test(csv), 'toCSV() exporta capçalera i valors');
  } catch(e){ log(false, 'toCSV() ha fallat: '+e.message); }

  try{
    const center = state.parcel.getBounds().getCenter();
    log(insideParcel(center) === true, 'insideParcel() retorna true dins la parcel·la DEMO');
  } catch(e){ log(false, 'insideParcel() ha fallat: '+e.message); }
})();

// --- PWA: Service Worker ---
(function registerSW(){
  if (!('serviceWorker' in navigator)) return;
  navigator.serviceWorker.register('sw.js').catch(function(){
    var swCode = `
      const CACHE = 'birdcensus-cache-v1';
      self.addEventListener('install', (e) => {
        self.skipWaiting();
        e.waitUntil((async()=>{
          const c = await caches.open(CACHE);
          try { await c.addAll(['./','./index.html']); } catch(_){}
        })());
      });
      self.addEventListener('activate', (e)=>{
        e.waitUntil((async()=>{
          const keys = await caches.keys();
          await Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)));
          self.clients.claim();
        })());
      });
      self.addEventListener('fetch', (e)=>{
        const req = e.request;
        if (req.method !== 'GET') return;
        e.respondWith((async()=>{
          const cache = await caches.open(CACHE);
          const cached = await cache.match(req);
          if (cached) return cached;
          try {
            const res = await fetch(req);
            if (res && res.status===200 && res.type==='basic') cache.put(req, res.clone());
            return res;
          } catch(err){
            return cached || Response.error();
          }
        })());
      });
    `;
    var blob = new Blob([swCode], {type: 'text/javascript'});
    var url = URL.createObjectURL(blob);
    navigator.serviceWorker.register(url).catch(function(err){
      console.warn('No s\'ha registrat el Service Worker:', err);
    });
  });
})();

(function ensureManifest(){
  var link = document.querySelector('link[rel="manifest"]');
  if (!link) return;
  fetch(link.href).catch(function(){
    console.info('%cPer a instal·lar com PWA, crea manifest.webmanifest (s'ha loguejat un exemple).', 'color:#2563eb');
    console.info(`{
  "name": "Cens d'ocells",
  "short_name": "Censos",
  "start_url": ".",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#111827",
  "icons": [
    { "src": "icons/icon-192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "icons/icon-512.png", "sizes": "512x512", "type": "image/png" }
  ]
}`);
  });
})();

(function testPWA(){
  var out = document.getElementById('testOutput'); if (!out) return;
  function log(ok, msg){
    var el = document.createElement('div');
    el.className = ok ? 'test-pass' : 'test-fail';
    el.textContent = (ok ? '✓ ' : '✗ ') + msg;
    out.appendChild(el);
  }
  try{
    log('serviceWorker' in navigator, 'El navegador suporta Service Worker');
  }catch(e){ log(false, 'Service Worker test ha fallat: '+e.message); }
})();
</script>
</body>
</html>
