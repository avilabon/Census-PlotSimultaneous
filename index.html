<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Cens d'ocells — Mode segur</title>
  <base href="./">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    :root { --bg:#fff; --fg:#111827; --border:#e5e7eb; }
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #app { height:100%; display:grid; grid-template-rows:auto 1fr auto; }
    header { padding:10px 12px; border-bottom:1px solid var(--border); display:flex; gap:8px; align-items:center; }
    .btn { padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; }
    .pill { margin-left:auto; padding:2px 6px; border-radius:999px; background:#f3f4f6; font-size:12px; }
    #map { height:100vh; width:100%; position:relative; z-index:0; }
    /* Drawer bàsic */
    aside { position:fixed; top:0; right:0; bottom:0; width:92vw; max-width:440px; background:#fff; border-left:1px solid var(--border);
            transform:translateX(100%); transition:transform .25s ease; z-index:2147483647; display:flex; flex-direction:column; }
    aside.open { transform:translateX(0); }
    aside header { padding:10px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    aside .content { padding:10px; overflow:auto; }
    #backdrop { position:fixed; inset:0; background:rgba(0,0,0,.15); display:none; z-index:2147483000; }
    .panel-open #backdrop { display:block; }
    .panel-open #map, .panel-open .leaflet-container { pointer-events:none !important; }
    .leaflet-control-container { z-index: 10 !important; }

    footer { padding:8px 12px; border-top:1px solid var(--border); font-size:12px; color:#6b7280; }
    /* Diagnòstic */
    #diag { position:fixed; left:8px; bottom:8px; max-width:70vw; background:rgba(17,24,39,.9); color:#fff;
            padding:6px 8px; border-radius:8px; font-size:12px; z-index:2147483600; display:none; }
  </style>
</head>
<body>
<div id="app">
  <header>
    <button class="btn" id="btnTogglePanel">☰</button>
    <strong style="margin-left:4px">Cens d'ocells</strong>
    <span class="pill" id="status">Mode segur</span>
  </header>

  <div id="map"></div>
  <div id="backdrop" aria-hidden="true"></div>

  <aside id="panel">
    <header>
      <strong>Panell</strong>
      <button class="btn" id="btnClosePanel">✕</button>
    </header>
    <div class="content">
      <p>Aquest és un mode de diagnòstic minimal: si el mapa es veu i els botons responen, la base és correcta ✅.</p>
      <p>Després afegirem la resta de funcionalitats (parcel·la, punts, exportacions, PWA) pas a pas.</p>
    </div>
  </aside>

  <footer>Si veus el mapa i el panell s'obre/tanca, ja tenim la base OK.</footer>
</div>

<div id="diag"></div>

<!-- Leaflet JS al final perquè no falli per ordre de càrrega -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
(function bootstrap(){
  // Logger d'errors visible
  var diagDiv = document.getElementById('diag');
  function diag(msg){ diagDiv.style.display='block'; diagDiv.textContent = msg; }
  window.addEventListener('error', e => diag('JS error: ' + e.message));
  window.addEventListener('unhandledrejection', e => diag('Promise error: ' + (e.reason && e.reason.message || e.reason)));

  try {
    // Inicia el mapa
    const map = L.map('map', { zoomControl: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
    map.setView([41.387, 2.170], 12);

    // Drawer handlers molt simples i robustos
    var panel = document.getElementById('panel');
    document.getElementById('btnTogglePanel').addEventListener('click', function(){
      panel.classList.add('open'); document.body.classList.add('panel-open');
    }, {passive:true});
    document.getElementById('btnClosePanel').addEventListener('click', function(){
      panel.classList.remove('open'); document.body.classList.remove('panel-open');
    }, {passive:true});
    document.getElementById('backdrop').addEventListener('click', function(){
      panel.classList.remove('open'); document.body.classList.remove('panel-open');
    }, {passive:true});
  } catch (e) {
    diag('Init error: ' + e.message);
  }
})();
</script>

<!-- IMPORTANT: no registrem cap Service Worker en mode segur -->
</body>
</html>
